<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#047857">
    <title>Kasir Ponpes Direct</title>
    
    <style>
        /* --- CSS RINGAN (Tanpa Download Luar) --- */
        :root { --primary: #047857; --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0; --text: #1e293b; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Layout Utilities */
        .hidden { display: none !important; }
        .flex { display: flex; } .items-center { align-items: center; } .justify-between { justify-content: space-between; } .gap-2 { gap: 0.5rem; }
        .w-full { width: 100%; } .text-sm { font-size: 0.875rem; } .font-bold { font-weight: 700; }
        
        /* Header */
        .header { background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border); padding: 0.8rem 1rem; position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .icon-btn { background: none; border: none; padding: 0.5rem; border-radius: 50%; color: #64748b; cursor: pointer; }
        .icon-btn:active { background: var(--border); }

        /* Main Area */
        .main-scroll { flex: 1; overflow-y: auto; padding: 1rem; padding-bottom: 6rem; }
        .container { max-width: 600px; margin: 0 auto; }

        /* Inputs & Grid */
        .input-box { background: var(--surface); border: 1px solid var(--border); border-radius: 0.75rem; padding: 0.25rem 0.75rem; display: flex; align-items: center; margin-bottom: 1rem; }
        .clean-input { width: 100%; padding: 0.75rem; border: none; outline: none; font-size: 1rem; background: transparent; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; cursor: pointer; position: relative; }
        .card:active { transform: scale(0.98); background: #f1f5f9; }
        .btn-del { position: absolute; top: 5px; right: 5px; background: #fee2e2; color: #ef4444; width: 24px; height: 24px; border-radius: 50%; border: none; font-weight: bold; display: flex; align-items: center; justify-content: center; }

        /* Bottom Bar */
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 20; background: transparent; pointer-events: none; }
        .summary-card { pointer-events: auto; background: var(--primary); color: white; margin: 1rem; border-radius: 1rem; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); cursor: pointer; transform: translateY(150%); transition: transform 0.3s; }
        .summary-card.show { transform: translateY(0); }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal.open { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 100%; border-radius: 1.5rem 1.5rem 0 0; padding: 1.5rem; transform: translateY(100%); transition: transform 0.3s; max-height: 85vh; display: flex; flex-direction: column; }
        .modal.open .modal-content { transform: translateY(0); }
        
        .btn-primary { width: 100%; background: var(--primary); color: white; border: none; padding: 1rem; border-radius: 0.75rem; font-weight: bold; font-size: 1rem; margin-top: 1rem; cursor: pointer; }
        .btn-primary:disabled { background: #cbd5e1; color: #94a3b8; }
        .btn-primary.connect { background: #0ea5e9; } /* Biru untuk connect */

        /* Printing Status Banner */
        .status-banner { background: #dbeafe; color: #1e40af; padding: 0.5rem 1rem; font-size: 0.75rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #bfdbfe; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; margin-left: 0.5rem; display: inline-block; }
        .status-dot.connected { background: #22c55e; box-shadow: 0 0 8px #22c55e; }

        /* Print Area (Hidden in UI) */
        @media print { 
            body > * { display: none !important; } 
            #print-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; } 
            @page { margin: 0; size: 58mm auto; }
        }
        #print-area { display: none; font-family: monospace; font-size: 11pt; font-weight: bold; color: black; line-height: 1.2; padding-bottom: 20px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .dashed { border-bottom: 1px dashed black; margin: 6px 0; }
        .center { text-align: center; }
    </style>
</head>
<body>

    <!-- STATUS BAR PRINTER -->
    <div id="printerStatus" class="status-banner hidden">
        <div class="flex items-center">
            <span id="printerName">Printer: Belum Terhubung</span>
            <div id="connectionDot" class="status-dot"></div>
        </div>
        <button onclick="connectPrinter()" style="background:none; border:none; color:inherit; text-decoration:underline; font-weight:bold;">Sambungkan</button>
    </div>

    <!-- HEADER -->
    <header class="header">
        <div class="flex items-center gap-2">
            <div style="background:#d1fae5; color:#047857; padding:0.5rem; border-radius:0.5rem;">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </div>
            <div>
                <h1 class="font-bold">Kasir Warung</h1>
                <div class="text-sm text-gray-500" id="trxId">ID: ...</div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="openHistory()" class="icon-btn" title="Riwayat">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </button>
            <button onclick="resetApp()" class="icon-btn" title="Reset">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            </button>
        </div>
    </header>

    <!-- MAIN -->
    <main class="main-scroll">
        <div class="container">
            <div class="input-box">
                <input type="text" id="inputNama" class="clean-input" placeholder="Nama Pelanggan..." oninput="state.name=this.value">
            </div>

            <div class="flex justify-between items-end mb-3">
                <h2 class="text-sm font-bold text-gray-500">MENU BARANG</h2>
                <button onclick="openModal('modalProduct')" class="text-sm font-bold text-emerald-700 bg-emerald-100 px-3 py-1 rounded">+ Menu Custom</button>
            </div>

            <div class="grid" id="gridProducts"></div>
        </div>
    </main>

    <!-- BOTTOM BAR -->
    <div class="bottom-bar">
        <div class="container">
            <div id="cartBar" class="summary-card" onclick="openCheckout()">
                <div>
                    <div class="text-xs opacity-90">Total Bayar</div>
                    <div class="text-xl font-bold" id="txtTotal">Rp0</div>
                </div>
                <div class="flex items-center gap-2 font-bold bg-white/20 px-3 py-1 rounded">
                    Bayar &rarr;
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CHECKOUT -->
    <div id="modalCheckout" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-lg">Pembayaran</h3>
                <button onclick="closeModal('modalCheckout')" class="font-bold text-xl">&times;</button>
            </div>
            
            <div id="checkoutList" class="flex-1 overflow-y-auto mb-4"></div>
            
            <div class="input-box">
                <span class="font-bold text-gray-500">Rp</span>
                <input type="tel" id="inputPay" class="clean-input font-bold text-lg" placeholder="Uang Pas" oninput="calcChange(this.value)">
            </div>
            
            <div class="flex justify-between bg-gray-900 text-white p-3 rounded-lg mb-2">
                <span>Kembali</span>
                <span class="font-bold" id="txtChange">Rp0</span>
            </div>

            <button id="btnPrint" onclick="doPrint()" class="btn-primary">CETAK STRUK</button>
        </div>
    </div>

    <!-- MODAL ADD PRODUCT -->
    <div id="modalProduct" class="modal">
        <div class="modal-content" style="max-height: 50vh;">
            <h3 class="font-bold text-lg mb-4">Tambah Menu</h3>
            <input id="newProdName" class="input-box w-full" placeholder="Nama Barang">
            <input id="newProdPrice" type="number" class="input-box w-full" placeholder="Harga">
            <button onclick="addProduct()" class="btn-primary">Simpan</button>
            <button onclick="closeModal('modalProduct')" class="btn-primary" style="background:#f1f5f9; color:#334155; margin-top:0.5rem">Batal</button>
        </div>
    </div>

    <!-- AREA STRUK (Tersembunyi) -->
    <div id="print-area">
        <div class="center" style="margin-top:10px;">
            <div style="font-size:1.2em;">KASIR WARUNG</div>
            <div>Ponpes Wali Barokah</div>
            <div>082143358005</div>
        </div>
        <div class="dashed"></div>
        <div class="receipt-row"><span>Nama</span><span id="pName">-</span></div>
        <div class="receipt-row"><span>No</span><span id="pId">...</span></div>
        <div class="receipt-row"><span>Tgl</span><span id="pDate">...</span></div>
        <div class="dashed"></div>
        <div id="pItems"></div>
        <div class="dashed"></div>
        <div class="receipt-row"><span>Total</span><span id="pTotal">0</span></div>
        <div class="receipt-row"><span>Bayar</span><span id="pPay">0</span></div>
        <div class="receipt-row"><span>Kembali</span><span id="pChange">0</span></div>
        <div class="dashed"></div>
        <div class="center" style="margin-top:5px;">Terima Kasih</div>
        <br><br>
    </div>

    <script>
        // --- DATA & STATE ---
        let state = { id: genId(), date: getDate(), name: '', cart: [], products: [] };
        let printDevice = null;
        let printChar = null; // Characteristic untuk write data

        // Data Awal
        const initialProducts = [
            { id: 1, name: 'Kalung', price: 10000 }, { id: 2, name: 'Gelang', price: 5000 },
            { id: 3, name: 'Cincin', price: 15000 }, { id: 4, name: 'Jam', price: 50000 },
            { id: 5, name: 'Bros', price: 3000 }, { id: 6, name: 'Peniti', price: 1000 }
        ];
        state.products = [...initialProducts];

        // --- CORE FUNCTIONS ---
        function renderGrid() {
            const grid = document.getElementById('gridProducts');
            grid.innerHTML = '';
            state.products.forEach(p => {
                const inCart = state.cart.find(c => c.id == p.id);
                const qty = inCart ? inCart.qty : 0;
                const el = document.createElement('div');
                el.className = `card ${qty > 0 ? 'border-green-500 bg-green-50' : ''}`;
                el.onclick = () => addToCart(p.id);
                el.innerHTML = `
                    <button class="btn-del" onclick="delProd(event, ${p.id})">Ã—</button>
                    <div class="font-bold mb-1">${p.name}</div>
                    <div class="text-sm text-gray-500">Rp${p.price.toLocaleString()}</div>
                    ${qty > 0 ? `<div class="mt-2 text-xs font-bold text-green-700 bg-green-200 inline-block px-2 rounded">${qty}x</div>` : ''}
                `;
                grid.appendChild(el);
            });
            updateTotal();
        }

        function addToCart(id) {
            const p = state.products.find(x => x.id == id);
            const exist = state.cart.find(x => x.id == id);
            if(exist) exist.qty++; else state.cart.push({...p, qty:1});
            renderGrid();
        }

        function delProd(e, id) {
            e.stopPropagation();
            if(confirm("Hapus menu ini?")) {
                state.products = state.products.filter(p => p.id != id);
                state.cart = state.cart.filter(c => c.id != id);
                renderGrid();
            }
        }

        function updateTotal() {
            const total = state.cart.reduce((a,b) => a + (b.price*b.qty), 0);
            document.getElementById('txtTotal').innerText = "Rp" + total.toLocaleString();
            
            const bar = document.getElementById('cartBar');
            if(state.cart.length > 0) bar.classList.add('show'); else bar.classList.remove('show');
        }

        function openCheckout() {
            const list = document.getElementById('checkoutList');
            list.innerHTML = '';
            state.cart.forEach(c => {
                list.innerHTML += `
                    <div class="flex justify-between items-center py-2 border-b">
                        <div>
                            <div class="font-bold">${c.name}</div>
                            <div class="text-xs text-gray-500">${c.qty} x ${c.price.toLocaleString()}</div>
                        </div>
                        <div class="font-bold">Rp${(c.price*c.qty).toLocaleString()}</div>
                    </div>
                `;
            });
            openModal('modalCheckout');
            calcChange('');
        }

        function calcChange(val) {
            const total = state.cart.reduce((a,b) => a + (b.price*b.qty), 0);
            const pay = val ? parseInt(val) : total;
            const change = pay - total;
            
            const txt = document.getElementById('txtChange');
            const btn = document.getElementById('btnPrint');
            
            if(change < 0) {
                txt.innerText = "Kurang Rp" + Math.abs(change).toLocaleString();
                txt.style.color = "#fca5a5";
                btn.disabled = true;
                btn.innerText = "UANG KURANG";
            } else {
                txt.innerText = "Rp" + change.toLocaleString();
                txt.style.color = "white";
                btn.disabled = false;
                btn.innerText = printChar ? "CETAK STRUK (BLUETOOTH)" : "CETAK STRUK (BROWSER)";
            }
        }

        // --- WEB BLUETOOTH API (DIRECT PRINT ENGINE) ---
        async function connectPrinter() {
            try {
                // Mencari perangkat Bluetooth (Filter umum untuk Thermal Printer)
                printDevice = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['000018f0-0000-1000-8000-00805f9b34fb'] } // Service UUID umum printer thermal
                    ],
                    optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
                });

                const server = await printDevice.gatt.connect();
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                // Karakteristik untuk menulis data (Write Characteristic)
                printChar = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

                // Update UI
                document.getElementById('printerStatus').classList.remove('hidden');
                document.getElementById('printerName').innerText = "Printer: " + printDevice.name;
                document.getElementById('connectionDot').classList.add('connected');
                document.getElementById('btnPrint').innerText = "CETAK STRUK (BLUETOOTH)";
                
                // Keep connection listener
                printDevice.addEventListener('gattserverdisconnected', () => {
                    document.getElementById('connectionDot').classList.remove('connected');
                    printChar = null;
                    alert("Printer terputus!");
                });

            } catch (error) {
                console.log(error);
                alert("Gagal konek: " + error + ".\n\nNOTE: Fitur ini butuh 'Bluetooth Low Energy' (BLE). Jika printer Anda tipe Classic (lama), fitur ini tidak akan bekerja di browser Chrome.");
            }
        }

        async function doPrint() {
            // Update Data Struk Hidden
            document.getElementById('pName').innerText = state.name || 'Umum';
            document.getElementById('pId').innerText = state.id;
            document.getElementById('pDate').innerText = state.date;
            
            const total = state.cart.reduce((a,b) => a + (b.price*b.qty), 0);
            const inputVal = document.getElementById('inputPay').value;
            const pay = inputVal ? parseInt(inputVal) : total;
            const change = pay - total;

            document.getElementById('pTotal').innerText = "Rp" + total.toLocaleString();
            document.getElementById('pPay').innerText = "Rp" + pay.toLocaleString();
            document.getElementById('pChange').innerText = "Rp" + change.toLocaleString();

            let itemsHtml = '';
            // Data text untuk Bluetooth
            let escData = '';
            const ESC = '\x1B'; const GS = '\x1D'; const NL = '\x0A';
            const CENTER = ESC + 'a' + '\x01'; const LEFT = ESC + 'a' + '\x00'; 
            const BOLD = ESC + 'E' + '\x01'; const NORMAL = ESC + 'E' + '\x00';

            // Header
            escData += ESC + '@'; // Init
            escData += CENTER + BOLD + "KASIR WARUNG" + NL;
            escData += NORMAL + "Ponpes Wali Barokah" + NL;
            escData += "082143358005" + NL + "--------------------------------" + NL + LEFT;
            
            escData += `Nama : ${state.name || '-'}` + NL;
            escData += `No   : ${state.id}` + NL;
            escData += "--------------------------------" + NL;

            state.cart.forEach(c => {
                // Update HTML
                itemsHtml += `<div class="mb-1"><div>${c.name}</div><div class="flex justify-between text-sm"><span>${c.qty}x ${c.price}</span><span>${c.qty*c.price}</span></div></div>`;
                
                // Update Bluetooth Data
                escData += c.name + NL;
                let linePrice = `${c.qty}x ${c.price}`;
                let lineTotal = `${c.qty * c.price}`;
                // Simple spacing logic (32 chars width)
                let spaces = 32 - linePrice.length - lineTotal.length;
                if(spaces < 0) spaces = 1;
                escData += linePrice + " ".repeat(spaces) + lineTotal + NL;
            });
            document.getElementById('pItems').innerHTML = itemsHtml;

            // Footer
            escData += "--------------------------------" + NL;
            
            const addTotalLine = (label, val) => {
                let vStr = "Rp" + val.toLocaleString();
                let spc = 32 - label.length - vStr.length;
                if(spc < 0) spc = 1;
                return label + " ".repeat(spc) + vStr + NL;
            };

            escData += BOLD + addTotalLine("Total", total) + NORMAL;
            escData += addTotalLine("Bayar", pay);
            escData += addTotalLine("Kembali", change);
            
            escData += "--------------------------------" + NL + CENTER;
            escData += "Terima Kasih" + NL + NL + NL; // Feed 3 lines

            // --- EXECUTION ---
            if (printChar) {
                // Send to Bluetooth
                const encoder = new TextEncoder();
                const data = encoder.encode(escData);
                try {
                    await printChar.writeValue(data);
                    closeModal('modalCheckout');
                    // Reset cart but keep name
                    state.cart = [];
                    state.id = genId();
                    renderGrid();
                } catch (e) {
                    alert("Gagal kirim data: " + e);
                }
            } else {
                // Fallback: Browser Print
                window.print();
            }
        }

        // --- HELPERS ---
        function genId() { return 'TRX' + Math.floor(Math.random() * 100000); }
        function getDate() { const d = new Date(); return `${d.getDate()}/${d.getMonth()+1} ${d.getHours()}:${d.getMinutes()}`; }
        
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        
        function addProduct() {
            const n = document.getElementById('newProdName').value;
            const p = document.getElementById('newProdPrice').value;
            if(n && p) {
                state.products.push({ id: Date.now(), name: n, price: parseInt(p) });
                closeModal('modalProduct');
                renderGrid();
            }
        }

        function resetApp() {
            if(confirm("Reset semua?")) {
                state.cart = []; state.name = ''; state.id = genId();
                document.getElementById('inputNama').value = '';
                renderGrid();
            }
        }

        // Init
        window.onload = () => {
            renderGrid();
            // Cek jika browser support Bluetooth
            if (navigator.bluetooth) {
                document.getElementById('printerStatus').classList.remove('hidden');
            }
        };
    </script>
</body>
</html>
